package com.example.apiclient;

import com.example.apiclient.formatter.WhatsappFormatter;
import com.example.apiclient.CommandRouter;
import org.springframework.http.MediaType;
import org.springframework.util.MultiValueMap;
import org.springframework.web.bind.annotation.*;

import java.time.Duration;
import java.util.List;

@RestController
@RequestMapping("/twilio")
public class TwilioWebhookController {

    private final CommandRouter router;

    public TwilioWebhookController(CommandRouter router) {
        this.router = router;
    }

    /**
     * Receives incoming WhatsApp messages from Twilio,
     * routes them through the CommandRouter, and responds with TwiML.
     */
    @PostMapping(
            value = "/wh",
            consumes = MediaType.APPLICATION_FORM_URLENCODED_VALUE,
            produces = MediaType.APPLICATION_XML_VALUE
    )
    public String inbound(@RequestBody MultiValueMap<String, String> form) {
        System.out.println("=== Twilio Webhook triggered ===");
        System.out.println("Form data: " + form);

        String from = form.getFirst("From");
        String body = form.getFirst("Body");
        if (body == null || body.isBlank()) body = "help";

        String rawReply;
        try {
            // Route command through your existing logic (e.g. /categories, /products, /cart, etc.)
            rawReply = router.handle(body).block(Duration.ofSeconds(20));
        } catch (Exception e) {
            e.printStackTrace();
            rawReply = "⚠️ Internal error: " + e.getMessage();
        }

        if (rawReply == null || rawReply.isBlank()) {
            rawReply = "⚠️ No data returned.";
        }

        // ✅ Format output for WhatsApp (emoji headings, alignment, etc.)
        String formatted = WhatsappFormatter.format(rawReply, body);

        // ✅ Split long messages safely for Twilio
        List<String> chunks = WhatsappFormatter.chunk(formatted);

        // ✅ Return valid TwiML response (multi-part support)
        return buildTwimlResponse(chunks);
    }

    private String buildTwimlResponse(List<String> parts) {
        StringBuilder sb = new StringBuilder();
        sb.append("<Response>");
        for (String part : parts) {
            sb.append("<Message>").append(escapeXml(part)).append("</Message>");
        }
        sb.append("</Response>");
        return sb.toString();
    }

    private String escapeXml(String s) {
        if (s == null) return "";
        return s.replace("&", "&amp;")
                .replace("<", "&lt;")
                .replace(">", "&gt;");
    }
}
