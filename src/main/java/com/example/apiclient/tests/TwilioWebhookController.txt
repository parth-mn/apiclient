package com.example.apiclient;

import com.example.apiclient.CommandRouter;
import com.example.apiclient.ai.NaturalLanguageRouter;
import com.example.apiclient.formatter.WhatsappFormatter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.http.MediaType;
import reactor.core.publisher.Mono;

import java.util.Map;

@RestController
@RequestMapping("/twilio")
public class TwilioWebhookController {

    private final CommandRouter router;
    private final NaturalLanguageRouter nl;
    private final WhatsappFormatter formatter;

    @Autowired
    public TwilioWebhookController(CommandRouter router, NaturalLanguageRouter nl, WhatsappFormatter formatter) {
        this.router = router;
        this.nl = nl;
        this.formatter = formatter;
    }

    @PostMapping(value = "/wh", consumes = MediaType.APPLICATION_FORM_URLENCODED_VALUE,
                 produces = MediaType.APPLICATION_XML_VALUE)
    public String handleWebhook(@RequestParam Map<String, String> formData) {
        System.out.println("=== Twilio Webhook triggered ===");
        System.out.println("Form data: " + formData);

        String userMsg = formData.getOrDefault("Body", "").trim();
        System.out.println("Body received: " + userMsg);

        // ðŸ§  1. Route natural language â†’ command
        String cmd = nl.toCommand(userMsg);
        System.out.println("[Twilio] Mapped cmd: " + cmd);

        // ðŸ§© 2. Execute command
        String reply = router.handle(cmd).blockOptional().orElse("Something went wrong.");

        // ðŸ§± 3. Format nicely for WhatsApp
        String formatted = formatter.formatReply(cmd, reply);

        // ðŸ“¨ 4. Respond to Twilio with TwiML
        String twiml = "<Response><Message>" +
                escapeXml(formatted) +
                "</Message></Response>";

        System.out.println("[Twilio] TwiML reply:\n" + twiml);
        return twiml;
    }

    private static String escapeXml(String s) {
        return s.replace("&", "&amp;").replace("<", "&lt;").replace(">", "&gt;");
    }
}
