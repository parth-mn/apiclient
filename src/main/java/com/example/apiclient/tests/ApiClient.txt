package com.example.apiclient;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpStatusCode;
import org.springframework.stereotype.Component;
import org.springframework.web.reactive.function.client.WebClient;
import reactor.core.publisher.Mono;
import org.springframework.http.MediaType;
import org.springframework.util.MultiValueMap;


@Component
public class ApiClient {
    private final WebClient web;
    @Value("${app.distChannel}") String distChannel;
    @Value("${app.unitCode}")    String unitCode;

    public ApiClient(WebClient webClient) { this.web = webClient; }

    private WebClient.RequestHeadersSpec<?> withHeaders(WebClient.RequestHeadersSpec<?> req, String token) {
        return req.header("Authorization", "Bearer " + token)
                .header("Distribution-channel-code", distChannel)
                .header("unit-code", unitCode);
    }

    private <T> Mono<T> retrieve(WebClient.RequestHeadersSpec<?> spec, Class<T> type) {
        return spec.retrieve()
                .onStatus(HttpStatusCode::isError, resp ->
                        resp.bodyToMono(String.class).defaultIfEmpty("<no body>").flatMap(body ->
                                Mono.error(new IllegalStateException("OCC "
                                        + resp.statusCode().value() + " " + resp.statusCode()
                                        + " body=" + body))))
                .bodyToMono(type);
    }

    public <T> Mono<T> get(String uri, String token, Class<T> type) {
        return retrieve(withHeaders(web.get().uri(uri), token), type);
    }

    public <T> Mono<T> post(String uri, String token, Class<T> type) {
        return retrieve(withHeaders(web.post().uri(uri), token), type);
    }

    public <B, T> Mono<T> post(String uri, String token, B body, Class<T> type) {
        return retrieve(withHeaders(web.post().uri(uri).bodyValue(body), token), type);
    }

    public <T> Mono<T> put(String uri, String token, Class<T> type) {
        return retrieve(withHeaders(web.put().uri(uri), token), type);
    }

    public <T> Mono<T> postJson(String uri, String token, Object body, Class<T> type) {
        return webClient.post()
                .uri(uri)
                .header("Authorization", "Bearer " + token)
                .header("X-Distribution-Channel", distChannel)
                .header("X-Unit-Code", unitCode)
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(body)
                .retrieve()
                .onStatus(HttpStatusCode::isError, resp -> resp.bodyToMono(String.class)
                        .defaultIfEmpty("<no body>")
                        .flatMap(b -> Mono.error(new IllegalStateException(
                                "OCC " + resp.statusCode().value() + " " + resp.statusCode() + " body=" + b))))
                .bodyToMono(type);
    }

    // For medias/* where you want raw bytes (optional)
    public Mono<byte[]> getBytes(String uri, String token) {
        return withHeaders(web.get().uri(uri), token)
                .retrieve()
                .onStatus(HttpStatusCode::isError, resp ->
                        resp.bodyToMono(String.class).defaultIfEmpty("<no body>").flatMap(body ->
                                Mono.error(new IllegalStateException("OCC "
                                        + resp.statusCode().value() + " " + resp.statusCode()
                                        + " body=" + body))))
                .bodyToMono(byte[].class);
    }

    public <T> Mono<T> postForm(String uri, String token, MultiValueMap<String,String> form, Class<T> type) {
        return retrieve(
                withHeaders(web.post()
                        .uri(uri)
                        .contentType(MediaType.APPLICATION_FORM_URLENCODED)
                        .bodyValue(form), token),
                type
        );
    }

}
